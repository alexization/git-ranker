server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: git-ranker-logs
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'

      - source_labels: ['container']
        regex: 'git-ranker-api'
        action: keep

      - target_label: 'app'
        replacement: 'api'

      - target_label: 'env'
        replacement: 'prod'

    pipeline_stages:
      - docker: {}

      # JSON 파싱 - 모든 필드 추출
      - json:
          expressions:
            level: level
            log_category: log_category
            event_type: event_type
            trace_id: trace_id
            msg: message
            http_method: http_method
            request_uri: request_uri
            http_status: http_status
            latency_ms: latency_ms
            username: username
            node_id: node_id
            tier: tier
            tier_from: tier_from
            tier_to: tier_to
            score: score
            score_from: score_from
            score_to: score_to
            ranking: ranking
            job_name: job_name
            step_name: step_name
            batch_total_count: batch_total_count
            batch_processed_count: batch_processed_count
            batch_success_count: batch_success_count
            batch_fail_count: batch_fail_count
            batch_skip_count: batch_skip_count
            batch_progress_percent: batch_progress_percent
            batch_duration_ms: batch_duration_ms
            github_api_cost: github_api_cost
            github_api_remaining: github_api_remaining
            github_api_reset_at: github_api_reset_at
            github_api_call_time_ms: github_api_call_time_ms
            error_code: error_code
            error_message: error_message
            auth_method: auth_method
            auth_failure_reason: auth_failure_reason

      - labels:
          level:
          log_category:
          event_type:
          http_method:

      - template:
          source: http_status
          template: '{{ if .http_status }}{{ if regexMatch "^2" .http_status }}2xx{{ else if regexMatch "^3" .http_status }}3xx{{ else if regexMatch "^4" .http_status }}4xx{{ else if regexMatch "^5" .http_status }}5xx{{ else }}other{{ end }}{{ end }}'
      - labels:
          status_group:

      - match:
          selector: '{log_category="BATCH"}'
          stages:
            - labels:
                job_name:

      - timestamp:
          source: "@timestamp"
          format: RFC3339