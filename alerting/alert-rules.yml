apiVersion: 1

groups:
  - orgId: 1
    name: System Health
    folder: Git Ranker Alerts
    interval: 1m
    rules:
      - uid: high-error-rate
        title: High Error Rate (5xx)
        condition: E
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(http_server_requests_seconds_count{application="git-ranker-api", status=~"5.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(http_server_requests_seconds_count{application="git-ranker-api"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: C
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              type: reduce
          - refId: D
            datasourceUid: __expr__
            model:
              expression: B
              reducer: last
              type: reduce
          - refId: E
            datasourceUid: __expr__
            model:
              expression: ($C > 0) && ($D > 0) && (($C / $D) * 100 > 5)
              type: math
        dashboardUid: git-ranker-ops
        panelId: 2
        noDataState: OK
        execErrState: OK
        for: 5m
        annotations:
          summary: High Error Rate Detected
          description: "Error rate is above 5%. (Errors: {{ $values.C.Value }}, Total: {{ $values.D.Value }})"
        labels:
          severity: critical

      - uid: service-down
        title: Service Unavailable
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job="spring-actuator"}
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              expression: $B < 1
              type: math
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          summary: Git Ranker API service is down
          description: "The application is not responding to health checks. Value: {{ $values.B.Value }}"
        labels:
          severity: critical

  - orgId: 1
    name: GitHub API
    folder: Git Ranker Alerts
    interval: 2m
    rules:
      - uid: github-rate-limit-low
        title: GitHub API Rate Limit Low
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: github_api_remaining{application="git-ranker-api"}
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              expression: $B < 100
              type: math
        dashboardUid: git-ranker-ops
        panelId: 30
        noDataState: OK
        execErrState: Error
        for: 1m
        annotations:
          summary: GitHub API rate limit is running low
          description: "Remaining API calls: {{ $values.B.Value }}"
        labels:
          severity: warning

  - orgId: 1
    name: Application Errors
    folder: Git Ranker Alerts
    interval: 1m
    rules:
      - uid: high-error-log-count
        title: High Error Log Count
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: loki
            model:
              expr: count_over_time({app="api", level="ERROR"} [1m])
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              expression: $B > 5
              type: math
        dashboardUid: git-ranker-ops
        panelId: 6
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: Error logs detected
          description: "Error logs count (last 1m): {{ $values.B.Value }}"
        labels:
          severity: warning

  - orgId: 1
    name: Batch Jobs
    folder: Git Ranker Alerts
    interval: 5m
    rules:
      - uid: batch-job-failure
        title: Batch Job Failed
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: loki
            model:
              expr: count_over_time({app="api", event=~"BATCH_COMPLETED|BATCH_ITEM_FAILED", level="ERROR"} [1h])
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            datasourceUid: __expr__
            model:
              expression: A
              reducer: last
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              expression: $B > 0
              type: math
        dashboardUid: git-ranker-ops
        panelId: 21
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          summary: A batch job has failed
          description: "Batch job errors in the last hour: {{ $values.B.Value }}"
        labels:
          severity: critical