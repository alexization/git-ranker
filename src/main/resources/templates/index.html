<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Git Ranker - 개발자 전투력 측정기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .hero-section {
            background: linear-gradient(135deg, #24292e 0%, #2b3137 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .tier-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        /* 티어별 색상 */
        .text-DIAMOND { color: #b9f2ff; text-shadow: 0 0 10px #00d4ff; }
        .text-PLATINUM { color: #00ced1; }
        .text-GOLD { color: #ffd700; }
        .text-SILVER { color: #c0c0c0; }
        .text-BRONZE { color: #cd7f32; }
        .text-IRON { color: #5f5f5f; }

        .diff-badge {
            font-size: 0.75rem;
            vertical-align: top;
            margin-left: 2px;
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-3 fs-4">GitHub 데이터를 분석 중입니다...</div>
    <div class="text-white-50 small">(최대 10초 정도 소요될 수 있습니다)</div>
</div>

<header class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 fw-bold"><i class="fab fa-github"></i> Git Ranker</h1>
        <p class="lead">단순 커밋 수가 아닌, <strong>코드의 품질과 기여도</strong>로 당신의 티어를 확인하세요.</p>

        <div class="row justify-content-center mt-4">
            <div class="col-md-8">
                <div class="alert alert-dark border-0 bg-dark bg-opacity-50 text-light text-start" role="alert">
                    <h5 class="alert-heading fs-6"><i class="fas fa-info-circle"></i> 유의사항 및 점수 산정 기준</h5>
                    <ul class="mb-0 small ps-3">
                        <li>Public Repository의 지난 1년 간 활동 데이터만 집계됩니다.</li>
                        <li>점수: Commit(1점), Issue(2점), Review(3점), PR Open(5점), PR Merged(10점).</li>
                        <li>이미 등록된 사용자는 매일 새벽 자동으로 점수가 갱신됩니다.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>

<main class="container">
    <section class="row justify-content-center mb-5">
        <div class="col-md-6">
            <div class="input-group input-group-lg shadow-sm">
                <span class="input-group-text bg-white"><i class="fab fa-github"></i></span>
                <input type="text" id="usernameInput" class="form-control" placeholder="GitHub Username 입력 (예: alexization)" aria-label="Username">
                <button class="btn btn-dark px-4" type="button" onclick="registerUser()">분석하기</button>
            </div>
        </div>
    </section>

    <section id="resultSection" class="mb-5 d-none">
        <div class="card shadow border-0">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-lg-4 text-center border-end-lg mb-4 mb-lg-0">
                        <img id="resProfileImage" src="" alt="Profile" class="rounded-circle mb-3 shadow-sm" width="120" height="120">
                        <div>
                            <i id="resTierIcon" class="fas fa-gem tier-icon"></i>
                            <h3 id="resTierText" class="fw-bold mb-1">DIAMOND</h3>
                            <p class="text-muted mb-0">
                                상위 <span id="resPercentile" class="fw-bold text-dark">0.1</span>%
                                (<span id="resRanking">1</span>위)
                            </p>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="text-center mb-4">
                            <h5 class="text-muted text-uppercase small ls-1">Total Score</h5>
                            <h1 class="display-3 fw-bold text-primary" id="resTotalScore">8,420</h1>
                            <p class="text-muted small">최종 업데이트: <span id="resUpdatedAt">2024-03-01</span></p>
                        </div>

                        <div class="row g-3 text-center">
                            <div class="col-4 col-md">
                                <div class="p-3 bg-light rounded stat-card">
                                    <div class="fs-4 text-secondary mb-1"><i class="fas fa-code-branch"></i></div>
                                    <div class="small text-muted">Commits</div>
                                    <div class="fw-bold fs-5">
                                        <span id="statCommit">0</span>
                                        <span id="diffCommit" class="badge rounded-pill bg-success diff-badge">+0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4 col-md">
                                <div class="p-3 bg-light rounded stat-card">
                                    <div class="fs-4 text-warning mb-1"><i class="fas fa-exclamation-circle"></i></div>
                                    <div class="small text-muted">Issues</div>
                                    <div class="fw-bold fs-5">
                                        <span id="statIssue">0</span>
                                        <span id="diffIssue" class="badge rounded-pill bg-danger diff-badge">-1</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4 col-md">
                                <div class="p-3 bg-light rounded stat-card">
                                    <div class="fs-4 text-info mb-1"><i class="fas fa-glasses"></i></div>
                                    <div class="small text-muted">Reviews</div>
                                    <div class="fw-bold fs-5">
                                        <span id="statReview">0</span>
                                        <span id="diffReview" class="badge rounded-pill bg-success diff-badge">+2</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md">
                                <div class="p-3 bg-light rounded stat-card">
                                    <div class="fs-4 text-success mb-1"><i class="fas fa-share-square"></i></div>
                                    <div class="small text-muted">PR Open</div>
                                    <div class="fw-bold fs-5">
                                        <span id="statPrOpen">0</span>
                                        <span id="diffPrOpen" class="badge rounded-pill bg-secondary diff-badge">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md">
                                <div class="p-3 bg-light rounded stat-card">
                                    <div class="fs-4 text-purple mb-1" style="color: #6f42c1;"><i class="fas fa-check-double"></i></div>
                                    <div class="small text-muted">PR Merged</div>
                                    <div class="fw-bold fs-5">
                                        <span id="statPrMerged">0</span>
                                        <span id="diffPrMerged" class="badge rounded-pill bg-success diff-badge">+1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="my-5">
        <h3 class="fw-bold mb-4"><i class="fas fa-trophy text-warning"></i> 전체 랭킹 (Top 100)</h3>
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Tier</th>
                        <th scope="col" class="text-start">User</th>
                        <th scope="col">Total Score</th>
                        <th scope="col">Commits</th>
                        <th scope="col">Detail</th>
                    </tr>
                    </thead>
                    <tbody id="rankingTableBody">
                    <tr>
                        <td colspan="6" class="py-4 text-muted">랭킹 데이터를 불러오는 중...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white py-3">
                <nav>
                    <ul class="pagination justify-content-center mb-0" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </section>
</main>

<footer class="bg-dark text-white py-4 mt-5">
    <div class="container text-center">
        <p class="mb-1">&copy; 2024 Git Ranker. All rights reserved.</p>
        <p class="small text-white-50">
            Designed by <a href="https://github.com/alexization" class="text-white text-decoration-underline" target="_blank">@alexization</a>
        </p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE_URL = '/api/v1';

    // 페이지 로드 시 랭킹 조회
    document.addEventListener('DOMContentLoaded', () => {
        loadRankings(0);

        // 엔터키 입력 이벤트
        document.getElementById('usernameInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                registerUser();
            }
        });
    });

    // 1. 사용자 등록 및 분석 요청
    async function registerUser() {
        const username = document.getElementById('usernameInput').value.trim();
        if (!username) {
            alert('GitHub Username을 입력해주세요.');
            return;
        }

        showLoading(true);

        try {
            const response = await fetch(`${API_BASE_URL}/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username })
            });

            const result = await response.json();

            if (result.result === 'SUCCESS') {
                renderUserResult(result.data);
                loadRankings(0); // 랭킹 갱신
            } else {
                alert(`오류 발생: ${result.error.message}`);
            }
        } catch (error) {
            console.error('API Error:', error);
            alert('서버와 통신 중 오류가 발생했습니다.');
        } finally {
            showLoading(false);
        }
    }

    // 2. 결과 카드 렌더링
    function renderUserResult(data) {
        const section = document.getElementById('resultSection');
        section.classList.remove('d-none');

        // 기본 정보
        document.getElementById('resProfileImage').src = data.profileImage;
        document.getElementById('resTierText').innerText = data.tier;
        document.getElementById('resTierText').className = `fw-bold mb-1 text-${data.tier}`; // 색상 클래스 적용
        document.getElementById('resPercentile').innerText = data.percentile.toFixed(2);
        document.getElementById('resRanking').innerText = data.ranking;
        document.getElementById('resTotalScore').innerText = data.totalScore.toLocaleString();
        document.getElementById('resUpdatedAt').innerText = new Date().toLocaleDateString();

        // 상세 스탯 및 Diff 렌더링
        updateStatWithDiff('statCommit', 'diffCommit', data.commitCount, data.diffCommitCount);
        updateStatWithDiff('statIssue', 'diffIssue', data.issueCount, data.diffIssueCount);
        updateStatWithDiff('statReview', 'diffReview', data.reviewCount, data.diffReviewCount);
        updateStatWithDiff('statPrOpen', 'diffPrOpen', data.prCount, data.diffPrCount);
        updateStatWithDiff('statPrMerged', 'diffPrMerged', data.mergedPrCount, data.diffMergedPrCount);

        // 티어 아이콘 변경
        const iconClass = getTierIconClass(data.tier);
        document.getElementById('resTierIcon').className = `${iconClass} tier-icon text-${data.tier}`;

        // 결과 영역으로 스크롤 이동
        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 스탯 + 뱃지 업데이트 헬퍼 함수
    function updateStatWithDiff(statId, diffId, totalValue, diffValue) {
        document.getElementById(statId).innerText = totalValue.toLocaleString();

        const diffEl = document.getElementById(diffId);
        if (diffValue > 0) {
            diffEl.className = 'badge rounded-pill bg-success diff-badge';
            diffEl.innerText = `+${diffValue}`;
            diffEl.style.display = 'inline-block';
        } else if (diffValue < 0) {
            diffEl.className = 'badge rounded-pill bg-danger diff-badge';
            diffEl.innerText = `${diffValue}`; // - 부호 포함됨
            diffEl.style.display = 'inline-block';
        } else {
            diffEl.style.display = 'none'; // 0일 경우 숨김
        }
    }

    // 3. 랭킹 리스트 조회 (백엔드에 GET /ranks API가 구현되어 있다고 가정)
    // 만약 아직 구현 안 했다면, User 엔티티 조회 API를 사용해야 함
    async function loadRankings(page) {
        try {
            // TODO: 백엔드에 GET /api/v1/ranks?page=${page}&size=20 구현 필요
            // 현재는 예시 데이터를 사용하거나, 구현된 API 경로로 수정해야 합니다.
            // 일단 fetch 요청 코드는 작성해둡니다.
            /*
            const response = await fetch(`${API_BASE_URL}/ranks?page=${page}&size=20`);
            const result = await response.json();
            const users = result.data.content;
            */

            // [임시] API가 없으므로 화면 UI 테스트를 위해 'renderRankingTable([])' 호출 시
            // 테이블이 비어있음을 보여주도록 처리. 실제 연동 시 위 주석 해제.
            const users = []; // 실제 데이터로 교체 필요
            renderRankingTable(users, page);

        } catch (error) {
            console.error('Ranking Load Error:', error);
            document.getElementById('rankingTableBody').innerHTML =
                `<tr><td colspan="6" class="text-danger">랭킹 정보를 불러오지 못했습니다.</td></tr>`;
        }
    }

    function renderRankingTable(users, currentPage) {
        const tbody = document.getElementById('rankingTableBody');
        tbody.innerHTML = '';

        if (!users || users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="py-4">등록된 랭킹 데이터가 없습니다.</td></tr>`;
            return;
        }

        users.forEach((user, index) => {
            const rank = (currentPage * 20) + index + 1;
            const row = `
                <tr>
                    <td class="fw-bold">${rank}</td>
                    <td><span class="badge bg-light text-dark border text-${user.tier}">${user.tier}</span></td>
                    <td class="text-start">
                        <img src="${user.profileImage}" class="rounded-circle me-2" width="30" height="30">
                        <a href="https://github.com/${user.username}" target="_blank" class="text-decoration-none text-dark fw-bold">
                            ${user.username}
                        </a>
                    </td>
                    <td class="fw-bold text-primary">${user.totalScore.toLocaleString()}</td>
                    <td>${user.totalCommitCount || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="alert('준비 중입니다.')">View</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function getTierIconClass(tier) {
        switch(tier) {
            case 'DIAMOND': return 'fas fa-gem';
            case 'PLATINUM': return 'fas fa-medal'; // 임시 아이콘
            case 'GOLD': return 'fas fa-medal';
            case 'SILVER': return 'fas fa-medal';
            case 'BRONZE': return 'fas fa-medal';
            default: return 'fas fa-shield-alt'; // IRON
        }
    }

    function showLoading(isLoading) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = isLoading ? 'flex' : 'none';
    }
</script>

</body>
</html>